<head>
	<meta charset="utf8" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.0.11/dist/uPlot.min.css">
	<style>.box {padding: .5rem; border: 1px dashed grey;} #content {display: grid; grid-template-columns: auto auto auto; row-gap: 1rem;}</style>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/big.js/5.2.2/big.min.js"></script>
<script src="jalaali-js.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.7.3/localforage.min.js"></script>
<script src="../tse.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uplot@1.0.11/dist/uPlot.iife.min.js"></script>

<div id="content"></div>

<script>
(async function () {
	await tse.updateInstruments(); // only needed once in a trading day.
	const data = await tse.getPrices(['ذوب', 'فولاد']);
	const adjustedData = await tse.getPrices(['خساپا'], {adjustPrices: 1});

	const customCols1 = await tse.getPrices(['شپنا'], {columns: [4,7,8]}); // default names
	const customCols2 = await tse.getPrices(['شپنا'], {columns: [[4,'DATE'],[7,'MAX'],[8,'MIN']]}); // custom names
	
	// making some charts:
	makeChart(data[0], 'ذوب (پایانی)');
	makeChart(data[1], 'فولاد (پایانی)');
	makeChart(adjustedData[0], 'خساپا (پایانی)');
	makeChart(customCols1[0], 'شپنا (بیشترین)', {date:'Date',price:'PriceMax'});
	makeChart(customCols2[0], 'شپنا (کمترین)', {date:'DATE',price:'MIN'});
	
	// view column indexes and their names
	document.getElementById('content').append(
		new DOMParser().parseFromString('<div class="box"><table>'+tse.columnList.map(i=>'<tr><td>'+i.name+'</td> <td>'+i.fname+'</td></tr>').join('\n')+'</table></div>', 'text/html').children[0]
	);
})();

function makeChart(_data, title, customProps={}) {
	const opts = { width:600, height:400, series:[{},{}], legend:{show:true}, class:'box' };
	const data = [
		_data.map(i => convertDate(i.date || i[customProps.date])),
		_data.map(i => i.close || i[customProps.price]),
	];
	new uPlot({...opts, title}, data, document.getElementById('content'));
}
function convertDate(day) {
	let [s,y,m,d] = [];
  s = ''+day;
  y = parseInt( s.slice(0, 4) );
  m = parseInt( s.slice(4, 6) );
  d = parseInt( s.slice(6, 8) );
  return Date.UTC(y, m-1, d) / 1000;
}
</script>